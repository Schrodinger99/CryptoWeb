<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <title>Dashboard - CryptoChicks</title>
    <link href="css/output.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
  </head>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <body class="bg-gray-100 dark:bg-gray-900 flex">
    
  <!-- Navbar cargado dinámicamente -->
    <div id="navbar-placeholder"></div>
    <script>
        fetch('/partials/navbar.html')
        .then(res => {
            if (!res.ok) {
                throw new Error('Error al cargar la barra de navegación');
            }
            return res.text();
        })
        .then(html => { 
            document.getElementById('navbar-placeholder').innerHTML = html 
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('navbar-placeholder').innerHTML = '<div class="fixed w-16 h-screen bg-gray-800 text-white p-4">Error al cargar</div>';
        });
    </script>

  <!-- Content -->
  <!-- Main -->
    <main class="ml-16 group-hover:ml-64 transition-all duration-300 pt-32 pr-4 pb-4 pl-4 w-full max-w-5xl mx-auto">
      <h1 class="text-3xl text-gray-900 dark:text-white font-bold mb-6">Dashboard</h1>

      <!-- Top Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
          <h3 class="text-lg text-gray-900 dark:text-white font-semibold">Total de usuarios registrados</h3>
          <p class="text-2xl text-gray-900 dark:text-white font-bold">1,234</p>
          <span class="text-green-600 dark:text-green-400 text-sm">📈 8.5% Up from yesterday</span>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
          <h3 class="text-lg text-gray-900 dark:text-white font-semibold">Quests completadas hoy</h3>
          <p class="text-2xl text-gray-900 dark:text-white font-bold">128</p>
          <span class="text-green-600 dark:text-green-400 text-sm">📈 1.3% Up from past week</span>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
          <h3 class="text-lg text-gray-900 dark:text-white font-semibold">Tasa de retención semanal</h3>
          <p class="text-2xl text-gray-900 dark:text-white font-bold">73%</p>
          <span class="text-red-600 dark:text-red-400 text-sm">📉 4.3% Down from yesterday</span>
        </div>
      </div>

      <!-- Charts -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
        <div id="nationality-chart" style="height: 400px;"></div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
        <h2 class="text-xl text-gray-900 dark:text-white font-semibold mb-4 text-center">Distribución de quests por día</h2>
        <div id="stacked-bar-chart" style="height: 400px;"></div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
        <h2 class="text-xl text-gray-900 dark:text-white font-semibold mb-4 text-center">Avance porcentual por Módulo</h2>
        <div id="main" style="height: 400px;"></div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
        <h2 class="text-xl text-gray-900 dark:text-white font-semibold mb-4 text-center">Quests completadas por tipo</h2>
        <div id="quest-chart" style="height: 400px;"></div>
      </div>

    <!-- Plotting Charts -->
    <script>
      function currentTheme() {
        const stored = localStorage.getItem('theme');
        if (stored === 'dark') return 'dark';
        if (stored === 'light') return 'light';
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      // Gráfico de pastel
      var dom = document.getElementById('nationality-chart');
      var myChart = echarts.init(dom, currentTheme(), {
        renderer: 'canvas',
        useDirtyRect: false
      });
      var option = {
        backgroundColor: currentTheme() === 'dark' ? '#1f2937' : '#ffffff', // gray-800 en modo oscuro
        title: {
          text: 'Distribución de usuarios por nacionalidad',
          left: 'center'
        },
        tooltip: {
          trigger: 'item'
        },
        legend: {
          orient: 'vertical',
          left: 'left'
        },
        series: [
          {
            name: 'Accesos',
            type: 'pie',
            radius: '50%',
            data: [
              { value: 735, name: 'México' },
              { value: 580, name: 'Estados Unidos' },
              { value: 484, name: 'Europa' },
              { value: 300, name: 'Sudamérica' }
            ],
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            }
          }
        ]
      };
      myChart.setOption(option);

      // Gráfico de barras apiladas
      var stackedChartDom = document.getElementById('stacked-bar-chart');
      var stackedChart = echarts.init(stackedChartDom, currentTheme());
      var stackedOption = {
        backgroundColor: currentTheme() === 'dark' ? '#1f2937' : '#ffffff', // gray-800 en modo oscuro
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        legend: {},
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'value'
        },
        yAxis: {
          type: 'category',
          data: ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo']
        },
        series: [
          {
            name: 'Trivia',
            type: 'bar',
            stack: 'total',
            label: { show: true },
            emphasis: { focus: 'series' },
            data: [12, 15, 18, 14, 16, 9, 10]
          },
          {
            name: 'Memorama',
            type: 'bar',
            stack: 'total',
            label: { show: true },
            emphasis: { focus: 'series' },
            data: [10, 11, 9, 13, 14, 7, 8]
          },
          {
            name: 'Lección',
            type: 'bar',
            stack: 'total',
            label: { show: true },
            emphasis: { focus: 'series' },
            data: [20, 22, 21, 23, 25, 18, 19]
          },
          {
            name: 'Exploración',
            type: 'bar',
            stack: 'total',
            label: { show: true },
            emphasis: { focus: 'series' },
            data: [8, 7, 9, 6, 5, 4, 6]
          }
        ]
      };
      stackedChart.setOption(stackedOption);

      // Gráfico de barras ordenadas (Avance porcentual por Módulo)
      var chartDom = document.getElementById('main');
      var myChart = echarts.init(chartDom, currentTheme());
      var option = {
        backgroundColor: currentTheme() === 'dark' ? '#1f2937' : '#ffffff', // gray-800 en modo oscuro
        tooltip: {
          trigger: 'axis'
        },
        dataset: [
          {
            dimensions: ['modulo', 'porcentaje'],
            source: [
              ['Modulo 1', 92],
              ['Modulo 2', 75],
              ['Modulo 3', 83],
              ['Modulo 4', 68]
            ]
          },
          {
            transform: {
              type: 'sort',
              config: { dimension: 'porcentaje', order: 'desc' }
            }
          }
        ],
        xAxis: {
          type: 'category',
          axisLabel: { interval: 0 }
        },
        yAxis: {
          type: 'value',
          axisLabel: {
            formatter: '{value}%' // Agrega el símbolo de porcentaje al eje Y
          }
        },
        series: {
          type: 'bar',
          encode: { x: 'modulo', y: 'porcentaje' },
          datasetIndex: 1,
          showBackground: true,
          backgroundStyle: {
            color: 'rgba(180, 180, 180, 0.2)'
          },
          itemStyle: {
            color: '#60a5fa' // Color de las barras
          }
        }
      };
      myChart.setOption(option);

      // Gráfico de popularidad de quests
      var questChartDom = document.getElementById('quest-chart');
      var questChart = echarts.init(questChartDom, currentTheme());
      var questOption = {
        backgroundColor: currentTheme() === 'dark' ? '#1f2937' : '#ffffff', // gray-800 en modo oscuro
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        xAxis: {
          type: 'category',
          data: ['Ahorcados', 'Memoramas', 'Lección', 'Ejemplo4']
        },
        yAxis: {
          type: 'value'
        },
        series: [
          {
            name: 'Completadas',
            type: 'bar',
            data: [120, 200, 150, 80],
            label: {
              show: true,
              position: 'top'
            },
            itemStyle: {
              color: '#60a5fa'
            }
          }
        ]
      };
      questChart.setOption(questOption);
    </script>

    </main>
    
    <script src="../node_modules/flowbite/dist/flowbite.js"></script>
    <script>
      (function() {
        const toggle = document.getElementById('theme-toggle');
        const root = document.documentElement;
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'dark' || (!storedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          root.classList.add('dark');
        }
        toggle.addEventListener('click', () => {
          if (root.classList.toggle('dark')) {
            localStorage.setItem('theme', 'dark');
          } else {
            localStorage.setItem('theme', 'light');
          }
          // Re-init charts with new theme
          myChart.dispose();
          stackedChart.dispose();
          myChart.dispose();
          questChart.dispose();
          // call a function to re-create charts (could reload page or extract chart code into a function)
          location.reload();
        });
      })();
    </script>
  </body>
</html>
